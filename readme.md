### 分布式锁
##### Redis实现分布式锁
原理: setNx 
> 进入要分布式同步代码setNx,成功即获取锁,失败获取锁失败
> 执行完同步代码删除设置的key

用原生setSx有诸多不足
###### 注意点
- 不设超时时间,获取锁后宕机会死锁
- 设置超时时间要保证设置超时时间和setNx的原子性
- 设置超时时间要考虑执行操作是否会超过超时时间,要单开一个线程做检查,检查到还持有锁就延时
- Redis主从同步未成功期间,在从节点看不到最新锁状态
采用Redisson实现的锁解决了上述问题
##### Zookeeper实现分布式锁
原理：zookeeper的节点不能重复创建以及watcher机制和CP特性

>获取锁就是创建一个zk临时节点,释放锁就是删除
>请求入口判断节点是否已创建,已创建就进入阻塞等待被唤醒
>watcher监听临时节点被删除事件并唤醒等待的主线程
>zookeeper会保证每一个节点的数据都是一致的,即锁状态一致
>由于是临时节点所以宕机会自动删除,不用设置超时删除策略

缺点:速度慢

#### 代码分布
test 中有多线程请求修改Redis中数据的代码

原理 

分布式锁首先是一把本地锁

分布式锁依赖的是中间件的互斥功能而不是本地互斥代码

中间件对请求来自哪些客户端不敏感

==>故而 可用本地多线程来测试此类依赖中间件互斥的分布式锁




